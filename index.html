<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WavyPrompts</title>
    <link rel="icon" type="image/png" href="./logo.png">
    
    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FIX: Polyfill for process.env.NODE_ENV to prevent React crash -->
    <script>
      window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <!-- Suppress Babel Warning -->
    <script>
      (function() {
        const originalWarn = console.warn;
        console.warn = function(...args) {
          if (args[0] && typeof args[0] === 'string' && args[0].includes('in-browser Babel transformer')) return;
          originalWarn.apply(console, args);
        };
      })();
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Syne:wght@400;500;600;700;800&family=Unbounded:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
      @font-face {
        font-family: 'Milker';
        src: url('./Milker.otf') format('opentype'),
             url('./Milker.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
      }

      html {
        scroll-behavior: auto; /* Let Lenis handle scrolling */
        height: 100%;
      }

      body {
        font-family: 'Poppins', sans-serif;
        background-color: #020202; /* Darker background */
        color: #ffffff;
        font-weight: 400;
        margin: 0;
        overflow-x: hidden;
        min-height: 100vh;
      }
      
      h1, h2, h3, .font-display {
        font-family: 'Milker', 'Unbounded', 'Syne', sans-serif;
      }
      
      .glass-panel {
        background: rgba(20, 20, 20, 0.6);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
      }
      
      .glass-input {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        font-family: 'Poppins', sans-serif;
      }

      .glass-element {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .glass-element:hover {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* Refined Scrollbar for Y2K Aesthetic - Optional with Lenis but good fallback */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track {
        background: #020202;
        border-left: 1px solid rgba(255,255,255,0.05);
      }
      ::-webkit-scrollbar-thumb {
        background: #333; 
        border-radius: 99px;
        border: 2px solid #020202;
        transition: background 0.3s ease;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #5C5CFF; 
      }
      
      @keyframes breathe {
        0%, 100% { transform: scale(1.1); opacity: 0.2; }
        50% { transform: scale(1.2); opacity: 0.3; }
      }
      .animate-breathe {
        animation: breathe 10s ease-in-out infinite;
      }

      @keyframes text-reveal {
        0% { opacity: 0; filter: blur(12px); transform: translateY(10px); }
        100% { opacity: 1; filter: blur(0); transform: translateY(0); }
      }
      .animate-text-reveal {
        animation: text-reveal 1.2s cubic-bezier(0.19, 1, 0.22, 1) forwards;
      }
      
      /* Lenis Recommended CSS */
      html.lenis, html.lenis body {
        height: auto;
      }
      .lenis.lenis-smooth {
        scroll-behavior: auto !important;
      }
      .lenis.lenis-smooth [data-lenis-prevent] {
        overscroll-behavior: contain;
      }
      .lenis.lenis-stopped {
        overflow: hidden;
      }
      .lenis.lenis-scrolling iframe {
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react" data-type="module">
      import React, { useState, useEffect, useRef } from "https://esm.sh/react@18.2.0";
      import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";
      import { 
        Copy, Share2, Plus, X, ChevronLeft, Image as ImageIcon, 
        MoreHorizontal, Check, Pencil, Search, Sparkles, Loader2, AlertTriangle, Trash2, Upload, Link as LinkIcon
      } from "https://esm.sh/lucide-react@0.263.1";
      // Import Lenis (New Package Name)
      import Lenis from "https://esm.sh/lenis@1.1.14";
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.3";

      // --- SUPABASE CONFIGURATION ---
      const SUPABASE_URL = 'https://wkxmzwvysahrczxbesgk.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndreG16d3Z5c2FocmN6eGJlc2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTUwMTcsImV4cCI6MjA4MTM3MTAxN30.m7GZaKsWT9KhvAU3dR88cSbVwtK1_FTUM1QL4cf8PN0';
      
      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      // Data Mapping Helpers
      const mapFromDb = (row) => ({
        id: row.id,
        title: row.title,
        prompt: row.prompt,
        imageUrl: row.image_url,
        category: row.category,
        createdAt: row.created_at ? new Date(row.created_at).getTime() : Date.now()
      });

      const mapToDb = (data) => ({
        id: data.id,
        title: data.title,
        prompt: data.prompt,
        image_url: data.imageUrl,
        category: data.category,
        created_at: new Date(data.createdAt).toISOString()
      });

      // API Functions
      const fetchPrompts = async () => {
        const { data, error } = await supabase
          .from('prompts')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error("Supabase Fetch Error:", error);
          throw error;
        }
        return data.map(mapFromDb);
      };

      const uploadImageToSupabase = async (file) => {
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
        const filePath = `${fileName}`;

        // Upload to 'images' bucket
        const { error: uploadError } = await supabase.storage
          .from('images')
          .upload(filePath, file);

        if (uploadError) {
          throw uploadError;
        }

        // Get public URL
        const { data } = supabase.storage.from('images').getPublicUrl(filePath);
        return data.publicUrl;
      };

      const savePromptToSupabase = async (prompt) => {
        const dbPayload = mapToDb(prompt);
        const { error } = await supabase
          .from('prompts')
          .upsert(dbPayload, { onConflict: 'id' });
        
        if (error) {
          console.error("Supabase Save Error:", error);
          throw error;
        }
      };

      const deletePromptFromSupabase = async (id) => {
        const { error } = await supabase
          .from('prompts')
          .delete()
          .eq('id', id);
        
        if (error) {
          console.error("Supabase Delete Error:", error);
          throw error;
        }
      };

      // Utility Functions
      const encodeShareData = (data) => {
        try {
          const payload = {
            title: data.title,
            prompt: data.prompt,
            imageUrl: data.imageUrl,
            category: data.category || 'NanoBanana'
          };
          const json = JSON.stringify(payload);
          return btoa(String.fromCharCode(...new TextEncoder().encode(json)));
        } catch (e) {
          console.error("Failed to encode share data", e);
          return "";
        }
      };

      const decodeShareData = (encoded) => {
        try {
          const binaryString = atob(encoded);
          const bytes = Uint8Array.from(binaryString, c => c.charCodeAt(0));
          const json = new TextDecoder().decode(bytes);
          return JSON.parse(json);
        } catch (e) {
          console.error("Failed to decode shared data", e);
          return null;
        }
      };

      // Components

      const Button = ({ 
        children, 
        variant = 'primary', 
        fullWidth = false, 
        className = '', 
        ...props 
      }) => {
        const baseStyles = "inline-flex items-center justify-center transition-all duration-200 font-medium tracking-wide disabled:opacity-50 disabled:cursor-not-allowed";
        const variants = {
          primary: "bg-[#5C5CFF] hover:bg-[#4a4aff] text-white rounded-full px-6 py-3 shadow-[0_0_20px_-5px_#5C5CFF]",
          secondary: "bg-white text-black hover:bg-gray-200 rounded-full px-6 py-3",
          ghost: "bg-transparent text-white/70 hover:text-white hover:bg-white/10 rounded-lg p-2",
          icon: "bg-white/10 hover:bg-white/20 text-white rounded-full p-2 backdrop-blur-md",
          danger: "bg-red-500/10 hover:bg-red-500/20 text-red-400 hover:text-red-300 rounded-full px-4 py-3 border border-red-500/20"
        };
        return (
          <button className={`${baseStyles} ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className}`} {...props}>
            {children}
          </button>
        );
      };

      // Updated PromptCard Component
      const PromptCard = ({ data, onClick, onEdit }) => {
        const [copied, setCopied] = useState(false);
        const category = data.category || 'NanoBanana';

        const handleShare = (e) => {
          e.stopPropagation();
          const encoded = encodeShareData(data);
          if (!encoded) return;
          
          const url = `${window.location.origin}${window.location.pathname}#/share/${encoded}`;
          
          navigator.clipboard.writeText(url).then(() => {
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
          }).catch(err => {
            console.error("Failed to copy link", err);
            try {
              const input = document.createElement('input');
              input.value = url;
              document.body.appendChild(input);
              input.select();
              document.execCommand('copy');
              document.body.removeChild(input);
              setCopied(true);
              setTimeout(() => setCopied(false), 2000);
            } catch (fallbackErr) {
              console.error("Copy fallback failed", fallbackErr);
            }
          });
        };

        const handleEdit = (e) => {
          e.stopPropagation();
          onEdit();
        }
        
        const getDotColor = (c) => {
          switch(c) {
            case 'NanoBanana': return 'bg-[#FFD700] shadow-[0_0_8px_rgba(255,215,0,0.5)]';
            case 'Midjourney': return 'bg-[#00BFFF] shadow-[0_0_8px_rgba(0,191,255,0.5)]';
            case 'Seedream': return 'bg-[#00FA9A] shadow-[0_0_8px_rgba(0,250,154,0.5)]';
            default: return 'bg-white';
          }
        };

        return (
          <div onClick={onClick} className="group cursor-pointer flex flex-col gap-4">
            <div className="relative w-full aspect-[4/5] rounded-[32px] overflow-hidden border border-white/5 bg-[#050505] z-10 shadow-2xl ring-1 ring-white/5 group-hover:ring-white/10 transition-all duration-500">
              {data.imageUrl ? (
                <img 
                  src={data.imageUrl} 
                  alt={data.title} 
                  className="w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-[1.03]" 
                  loading="lazy" 
                />
              ) : (
                <div className="w-full h-full flex flex-col items-center justify-center text-white/20 bg-white/5"><ImageIcon size={48} /></div>
              )}
            </div>

            <div className="flex flex-col gap-2">
              <h3 className="text-lg md:text-xl font-extrabold font-display text-white tracking-tight truncate px-1">{data.title}</h3>
              <div className="flex items-center justify-between gap-3 px-1 w-full">
                <div className="glass-element flex items-center gap-2 px-2.5 py-1.5 md:px-3 md:py-2 rounded-full transition-all duration-300 hover:bg-white/10 border border-white/10">
                  <div className={`w-1.5 h-1.5 md:w-2 md:h-2 rounded-full flex-shrink-0 ${getDotColor(category)}`}></div>
                  <span className="text-[10px] md:text-xs font-bold uppercase tracking-widest text-white/90 font-display whitespace-nowrap">{category}</span>
                </div>
                <div className="flex items-center gap-2 flex-shrink-0">
                  <button 
                    onClick={handleEdit} 
                    className="glass-element w-9 h-9 md:w-10 md:h-10 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-all border border-white/10 group/btn"
                    title="Edit"
                  >
                    <Pencil size={15} strokeWidth={2.5} />
                  </button>
                  <button 
                    onClick={handleShare} 
                    className={`glass-element w-9 h-9 md:w-10 md:h-10 flex items-center justify-center rounded-full transition-all border border-white/10 ${copied ? 'bg-white text-black border-white hover:bg-white/90' : 'text-white/70 hover:text-white hover:bg-white/10'}`}
                    title="Share"
                  >
                    {copied ? <Check size={16} strokeWidth={3} /> : <Share2 size={16} strokeWidth={2.5} />}
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const AddModal = ({ isOpen, onClose, onSave, onDelete, initialData }) => {
        const [title, setTitle] = useState('');
        const [prompt, setPrompt] = useState('');
        const [imageMode, setImageMode] = useState('upload'); // 'link' or 'upload'
        const [imageUrl, setImageUrl] = useState('');
        const [selectedFile, setSelectedFile] = useState(null);
        const [previewUrl, setPreviewUrl] = useState('');
        const [category, setCategory] = useState('NanoBanana');
        const [isSaving, setIsSaving] = useState(false);
        const [isDeleting, setIsDeleting] = useState(false);
        const fileInputRef = useRef(null);

        useEffect(() => {
          if (isOpen && initialData) {
            setTitle(initialData.title);
            setPrompt(initialData.prompt);
            setImageUrl(initialData.imageUrl);
            setPreviewUrl(initialData.imageUrl);
            setImageMode('link'); // Default to link when editing existing unless we want to replace
            setCategory(initialData.category || 'NanoBanana');
            setSelectedFile(null);
          } else if (isOpen && !initialData) {
            setTitle('');
            setPrompt('');
            setImageUrl('');
            setPreviewUrl('');
            setImageMode('upload');
            setCategory('NanoBanana');
            setSelectedFile(null);
          }
        }, [isOpen, initialData]);

        const handleFileChange = (e) => {
          const file = e.target.files[0];
          if (file) {
            setSelectedFile(file);
            setPreviewUrl(URL.createObjectURL(file));
          }
        };

        if (!isOpen) return null;

        const handleSubmit = async (e) => {
          e.preventDefault();
          setIsSaving(true);
          
          let finalImageUrl = imageUrl;

          try {
            // Handle File Upload if mode is 'upload' and file selected
            if (imageMode === 'upload' && selectedFile) {
              finalImageUrl = await uploadImageToSupabase(selectedFile);
            } else if (imageMode === 'upload' && !selectedFile && !initialData) {
              // Fallback if adding new and no file selected
              finalImageUrl = 'https://picsum.photos/800/1000'; 
            } else if (imageMode === 'upload' && !selectedFile && initialData) {
              // Keep existing if editing and no new file
              finalImageUrl = initialData.imageUrl;
            }

            const newPrompt = {
              id: initialData ? initialData.id : Date.now().toString(),
              title,
              prompt,
              imageUrl: finalImageUrl || 'https://picsum.photos/800/1000',
              category,
              createdAt: initialData ? initialData.createdAt : Date.now()
            };

            await onSave(newPrompt);
            onClose();
          } catch (err) {
            console.error(err);
            alert("Failed to save. If uploading, ensure 'images' bucket exists and is public in Supabase.");
          } finally {
            setIsSaving(false);
          }
        };
        
        const handleDelete = async () => {
          if (!confirm('Are you sure you want to delete this prompt?')) return;
          setIsDeleting(true);
          try {
            await onDelete(initialData.id);
            onClose();
          } catch (err) {
            alert("Failed to delete. Please try again.");
          } finally {
            setIsDeleting(false);
          }
        };

        const categories = ['NanoBanana', 'Midjourney', 'Seedream'];

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose} />
            <div data-lenis-prevent className="glass-panel w-full max-w-lg max-h-[90vh] overflow-y-auto rounded-3xl p-6 md:p-8 relative animate-in fade-in zoom-in-95 duration-200 overscroll-contain">
              <button onClick={onClose} className="absolute top-4 right-4 p-2 text-white/50 hover:text-white transition-colors z-10"><X size={24} /></button>
              <h2 className="text-xl md:text-2xl font-bold font-display mb-6 bg-gradient-to-r from-white to-white/50 bg-clip-text text-transparent">{initialData ? 'Edit Prompt' : 'Add to Vault'}</h2>
              <form onSubmit={handleSubmit} className="space-y-5 md:space-y-6">
                <div className="space-y-2"><label className="text-sm text-white/60 font-medium ml-1">Title</label><input required type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="e.g. Cyberpunk Cat" className="glass-input w-full rounded-xl px-4 py-3 focus:outline-none focus:border-[#5C5CFF]/50 transition-colors placeholder:text-white/20 appearance-none" /></div>
                
                <div className="space-y-2">
                  <label className="text-sm text-white/60 font-medium ml-1">Category</label>
                  <div className="flex gap-2 flex-wrap">
                    {categories.map((cat) => {
                       const isSelected = category === cat;
                       let activeClass = 'bg-[#5C5CFF] border-[#5C5CFF] text-white shadow-[0_0_15px_-5px_#5C5CFF]';
                       
                       if (cat === 'NanoBanana') activeClass = 'bg-yellow-400 border-yellow-400 text-black shadow-[0_0_15px_-5px_rgba(250,204,21,0.5)]';
                       if (cat === 'Midjourney') activeClass = 'bg-blue-400 border-blue-400 text-black shadow-[0_0_15px_-5px_rgba(96,165,250,0.5)]';
                       if (cat === 'Seedream') activeClass = 'bg-green-400 border-green-400 text-black shadow-[0_0_15px_-5px_rgba(74,222,128,0.5)]';

                       return (
                        <button key={cat} type="button" onClick={() => setCategory(cat)} className={`px-3 md:px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider transition-all border touch-manipulation ${isSelected ? activeClass : 'bg-white/5 border-white/10 text-white/60 hover:bg-white/10 hover:border-white/20'}`}>{cat}</button>
                       );
                    })}
                  </div>
                </div>

                <div className="space-y-3">
                  <label className="text-sm text-white/60 font-medium ml-1">Image (4:5 Aspect Ratio)</label>
                  
                  {/* Image Mode Toggles */}
                  <div className="flex p-1 bg-white/5 rounded-xl border border-white/10 w-fit mb-2">
                    <button type="button" onClick={() => setImageMode('upload')} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase transition-all ${imageMode === 'upload' ? 'bg-[#5C5CFF] text-white' : 'text-white/50 hover:text-white'}`}>
                      <Upload size={14} /> Upload
                    </button>
                    <button type="button" onClick={() => setImageMode('link')} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase transition-all ${imageMode === 'link' ? 'bg-[#5C5CFF] text-white' : 'text-white/50 hover:text-white'}`}>
                      <LinkIcon size={14} /> URL
                    </button>
                  </div>

                  {imageMode === 'upload' ? (
                     <div 
                      onClick={() => fileInputRef.current?.click()}
                      className="group relative w-full aspect-[4/5] max-h-[200px] rounded-xl border-2 border-dashed border-white/10 hover:border-[#5C5CFF]/50 bg-white/5 flex flex-col items-center justify-center cursor-pointer transition-all overflow-hidden"
                    >
                      {previewUrl ? (
                        <>
                          <img src={previewUrl} alt="Preview" className="w-full h-full object-cover opacity-60 group-hover:opacity-40 transition-opacity" />
                          <div className="absolute inset-0 flex items-center justify-center">
                            <span className="bg-black/50 backdrop-blur px-3 py-1 rounded-full text-xs font-medium text-white opacity-0 group-hover:opacity-100 transition-opacity">Change Image</span>
                          </div>
                        </>
                      ) : (
                        <div className="flex flex-col items-center gap-2 text-white/40 group-hover:text-[#5C5CFF] transition-colors">
                           <Upload size={24} />
                           <span className="text-xs font-bold uppercase tracking-wider">Click to Upload</span>
                        </div>
                      )}
                      <input 
                        ref={fileInputRef} 
                        type="file" 
                        accept="image/*" 
                        className="hidden" 
                        onChange={handleFileChange} 
                      />
                     </div>
                  ) : (
                    <div className="space-y-2">
                      <input type="url" value={imageUrl} onChange={(e) => { setImageUrl(e.target.value); setPreviewUrl(e.target.value); }} placeholder="https://..." className="glass-input w-full rounded-xl px-4 py-3 focus:outline-none focus:border-[#5C5CFF]/50 transition-colors placeholder:text-white/20 appearance-none" />
                      {previewUrl && (
                        <div className="w-20 h-24 rounded-lg overflow-hidden border border-white/10 bg-black/20">
                          <img src={previewUrl} className="w-full h-full object-cover" onError={(e) => e.target.style.display='none'} />
                        </div>
                      )}
                    </div>
                  )}
                </div>

                <div className="space-y-2"><label className="text-sm text-white/60 font-medium ml-1">Prompt</label><textarea required value={prompt} onChange={(e) => setPrompt(e.target.value)} placeholder="Describe your image generation prompt..." rows={5} className="glass-input w-full rounded-xl px-4 py-3 focus:outline-none focus:border-[#5C5CFF]/50 transition-colors placeholder:text-white/20 resize-none appearance-none" /></div>
                
                <div className="flex gap-3 mt-4">
                  {initialData && (
                    <Button type="button" variant="danger" onClick={handleDelete} disabled={isDeleting} className="shrink-0 aspect-square px-0 w-12 flex items-center justify-center">
                      {isDeleting ? <Loader2 className="animate-spin" size={20} /> : <Trash2 size={20} />}
                    </Button>
                  )}
                  <Button type="submit" fullWidth disabled={isSaving} className="shadow-lg shadow-[#5C5CFF]/20">
                    {isSaving ? (
                      <div className="flex items-center gap-2"><Loader2 className="animate-spin" size={20} /> <span>{imageMode === 'upload' && selectedFile ? 'Uploading...' : 'Saving...'}</span></div>
                    ) : (initialData ? 'Update Vault' : 'Save to Vault')}
                  </Button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      const FullView = ({ data, isOwner, onBack }) => {
        const [copied, setCopied] = useState(false);
        const [logoError, setLogoError] = useState(false);
        const category = data.category || 'NanoBanana';

        const handleCopy = async () => {
          try {
            await navigator.clipboard.writeText(data.prompt);
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
          } catch (err) { 
            try {
              const textarea = document.createElement('textarea');
              textarea.value = data.prompt;
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand('copy');
              document.body.removeChild(textarea);
              setCopied(true);
              setTimeout(() => setCopied(false), 2000);
            } catch (e) {
              console.error('Failed to copy', e); 
            }
          }
        };

        return (
          <div className="min-h-screen relative bg-black/90 text-white selection:bg-[#5C5CFF] selection:text-white pb-20 overflow-x-hidden">
            <div className="fixed inset-0 z-0 pointer-events-none overflow-hidden">
              <div className="absolute inset-0 bg-black/40 z-10" />
              <img 
                src={data.imageUrl} 
                alt="Background" 
                className="w-full h-full object-cover opacity-30 blur-[60px] scale-110 animate-breathe" 
              />
              <div className="absolute inset-0 opacity-20" style={{backgroundImage: 'radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
            </div>

            <div className="relative z-10 flex flex-col items-center justify-center p-4 md:p-8 min-h-screen">
              {isOwner && (
                <div className="fixed top-6 left-6 z-50">
                  <button onClick={onBack} className="flex items-center gap-2 text-white/60 hover:text-white transition-colors group">
                    <div className="p-2 rounded-full bg-black/20 group-hover:bg-black/40 backdrop-blur-md border border-white/10"><ChevronLeft size={20} /></div>
                    <span className="font-display text-sm tracking-widest uppercase opacity-0 group-hover:opacity-100 transition-opacity -translate-x-2 group-hover:translate-x-0 shadow-black drop-shadow-md">Back</span>
                  </button>
                </div>
              )}
              
              <div className="w-full max-w-[450px] animate-in fade-in slide-in-from-bottom-8 duration-500">
                <div className="flex justify-center mb-6">
                  {!logoError ? (
                    <img src="./logo.png" alt="WavyPrompts" className="w-20 h-20 rounded-2xl shadow-[0_0_30px_-5px_rgba(92,92,255,0.3)] border border-white/10 object-cover" onError={() => setLogoError(true)} />
                  ) : (
                    <div className="w-20 h-20 rounded-2xl bg-gradient-to-br from-[#5C5CFF]/20 to-purple-500/20 border border-white/10 flex items-center justify-center backdrop-blur-md shadow-[0_0_15px_rgba(92,92,255,0.3)]"><Sparkles size={32} className="text-[#5C5CFF]" fill="currentColor" fillOpacity={0.2} /></div>
                  )}
                </div>
                <h1 className="text-3xl font-bold font-display text-white mb-6 tracking-tight text-center truncate drop-shadow-lg">{data.title}</h1>
                <div className="relative w-full aspect-[4/5] rounded-[32px] overflow-hidden shadow-2xl border border-white/10 mb-6 bg-[#111]">
                  <img src={data.imageUrl} alt={data.title} className="w-full h-full object-cover" />
                </div>
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-2">
                    <div className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 backdrop-blur-md">
                      <div className={`w-2 h-2 rounded-full shadow-[0_0_8px_rgba(255,255,255,0.4)] ${category === 'NanoBanana' ? 'bg-yellow-400 shadow-yellow-400/50' : category === 'Midjourney' ? 'bg-blue-400 shadow-blue-400/50' : category === 'Seedream' ? 'bg-green-400 shadow-green-400/50' : 'bg-white'}`}></div>
                      <span className="text-[10px] font-bold uppercase tracking-wider text-white font-display">{category}</span>
                    </div>
                  </div>
                </div>
                <div data-lenis-prevent className="relative glass-panel rounded-3xl p-6 mb-8 border border-white/10 bg-[#161616]/80 backdrop-blur-xl">
                  <div className="absolute right-3 top-3 bottom-3 w-1.5 bg-white/5 rounded-full overflow-hidden"><div className="w-full h-1/3 bg-white/20 rounded-full mt-2"></div></div>
                  <div className="pr-4 max-h-[200px] overflow-y-auto no-scrollbar text-sm leading-relaxed text-gray-300 font-medium whitespace-pre-wrap animate-text-reveal">{data.prompt}</div>
                </div>
                <div className="flex items-center gap-4 pb-8">
                  <Button onClick={handleCopy} fullWidth className="h-14 text-base font-bold tracking-wide shadow-lg shadow-[#5C5CFF]/20">{copied ? 'Copied!' : 'Copy Prompt'}</Button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const App = () => {
        const [view, setView] = useState('gallery');
        const [prompts, setPrompts] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [selectedPrompt, setSelectedPrompt] = useState(null);
        const [sharedData, setSharedData] = useState(null);
        const [isAddModalOpen, setIsAddModalOpen] = useState(false);
        const [editingPrompt, setEditingPrompt] = useState(null);
        const [activeCategory, setActiveCategory] = useState('All');
        const [searchQuery, setSearchQuery] = useState('');
        const [logoError, setLogoError] = useState(false);

        // Fetch data on mount
        useEffect(() => {
          const loadData = async () => {
            setLoading(true);
            try {
              const data = await fetchPrompts();
              setPrompts(data);
              checkHash(data);
            } catch (err) {
              setError(err.message);
              checkHash([]); 
            } finally {
              setLoading(false);
            }
          };

          const checkHash = (currentPrompts) => {
            const hash = window.location.hash;
            if (hash.startsWith('#/share/')) {
              const decoded = decodeShareData(hash.split('#/share/')[1]);
              if (decoded) { setSharedData(decoded); setView('shared'); } 
              else { window.location.hash = ''; }
            } else if (hash.startsWith('#/view/')) {
              const id = hash.split('#/view/')[1];
              const found = currentPrompts.find(p => p.id === id);
              if (found) { setSelectedPrompt(found); setView('full'); } 
              else { window.location.hash = ''; setView('gallery'); }
            } else {
              setView('gallery'); setSelectedPrompt(null); setSharedData(null);
            }
          };

          loadData();
          
          // REAL-TIME SUBSCRIPTION
          const subscription = supabase
            .channel('public:prompts')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'prompts' }, () => {
              fetchPrompts().then(setPrompts).catch(console.error);
            })
            .subscribe();

          return () => {
            supabase.removeChannel(subscription);
          };
        }, []);
        
        // Handle hash changes reactively
        useEffect(() => {
          const handleHashChange = () => {
             const hash = window.location.hash;
             if (hash.startsWith('#/share/')) {
               const decoded = decodeShareData(hash.split('#/share/')[1]);
               if (decoded) { setSharedData(decoded); setView('shared'); }
             } else if (hash.startsWith('#/view/')) {
               const id = hash.split('#/view/')[1];
               const found = prompts.find(p => p.id === id);
               if (found) { setSelectedPrompt(found); setView('full'); }
               else if (!loading && prompts.length > 0) { 
                 window.location.hash = ''; 
                 setView('gallery');
               }
             } else {
               setView('gallery'); setSelectedPrompt(null); setSharedData(null);
             }
          };
          
          window.addEventListener('hashchange', handleHashChange);
          if (!loading) handleHashChange();
          return () => window.removeEventListener('hashchange', handleHashChange);
        }, [prompts, loading]);

        useEffect(() => {
          console.log("Initializing Lenis...");
          const lenis = new Lenis({
            duration: 1.2,
            easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
            orientation: 'vertical',
            gestureOrientation: 'vertical',
            smoothWheel: true,
            wheelMultiplier: 1,
            smoothTouch: false,
            touchMultiplier: 2,
          });

          function raf(time) {
            lenis.raf(time);
            requestAnimationFrame(raf);
          }

          requestAnimationFrame(raf);
          console.log("Lenis initialized.");

          return () => {
            lenis.destroy();
          };
        }, []);

        const handleSavePrompt = async (newPrompt) => {
          await savePromptToSupabase(newPrompt);
          // Optimistic update or wait for realtime. 
          // We will wait for realtime, but to make UI snappy we could refetch locally too.
          // Since we have a subscription, the UI will update automatically. 
          // But to be safe and ensure the user sees their change immediately:
          const data = await fetchPrompts();
          setPrompts(data);
          if (selectedPrompt && selectedPrompt.id === newPrompt.id) setSelectedPrompt(newPrompt);
        };
        
        const handleDeletePrompt = async (id) => {
          await deletePromptFromSupabase(id);
          // Refresh list immediately
          const data = await fetchPrompts();
          setPrompts(data);
        };

        const filteredPrompts = prompts.filter(p => {
          const matchesCategory = activeCategory === 'All' || (p.category || 'NanoBanana') === activeCategory;
          const matchesSearch = searchQuery === '' || p.title.toLowerCase().includes(searchQuery.toLowerCase()) || p.prompt.toLowerCase().includes(searchQuery.toLowerCase());
          return matchesCategory && matchesSearch;
        });

        const categories = ['All', 'NanoBanana', 'Midjourney', 'Seedream'];

        if (view === 'shared' && sharedData) return <FullView data={sharedData} isOwner={false} onBack={() => {}} />;
        if (view === 'full' && selectedPrompt) return <><FullView data={selectedPrompt} isOwner={true} onBack={() => window.location.hash = ''} /><AddModal isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} onSave={handleSavePrompt} onDelete={handleDeletePrompt} initialData={editingPrompt} /></>;

        return (
          <div className="min-h-screen relative text-white selection:bg-[#5C5CFF] selection:text-white overflow-x-hidden">
            <div className="fixed inset-0 z-[-1] pointer-events-none bg-[#020202] overflow-hidden">
              <div className="absolute top-[-20%] left-[-20%] w-[80vw] h-[80vw] rounded-full bg-[#5C5CFF]/3 blur-[120px] animate-pulse" style={{animationDuration: '8s'}}></div>
              <div className="absolute bottom-[-20%] right-[-20%] w-[80vw] h-[80vw] rounded-full bg-purple-600/3 blur-[120px] animate-pulse" style={{animationDuration: '10s'}}></div>
            </div>

            <header className="fixed top-0 left-0 right-0 z-30 px-4 md:px-6 py-4 md:py-6 bg-gradient-to-b from-[#020202] via-[#020202]/95 to-transparent pointer-events-none transition-all duration-300">
              <div className="flex items-center justify-between pointer-events-auto max-w-7xl mx-auto w-full">
                <div className="flex items-center gap-2 md:gap-3">
                  <div className="w-9 h-9 md:w-10 md:h-10 rounded-xl bg-gradient-to-br from-[#5C5CFF]/20 to-purple-500/20 border border-white/10 flex items-center justify-center backdrop-blur-md shadow-[0_0_15px_rgba(92,92,255,0.3)] overflow-hidden">
                    {!logoError ? (
                      <img src="./logo.png" alt="Logo" className="w-full h-full object-cover" onError={() => setLogoError(true)} />
                    ) : (
                      <Sparkles size={18} className="text-[#5C5CFF] md:w-5 md:h-5" fill="currentColor" fillOpacity={0.2} />
                    )}
                  </div>
                  <h1 className="text-xl md:text-2xl font-bold font-display tracking-tighter">Wavy<span className="text-[#5C5CFF]">Prompts</span></h1>
                </div>
                <button onClick={() => { setEditingPrompt(null); setIsAddModalOpen(true); }} className="flex items-center gap-2 px-4 py-2 md:px-5 md:py-2.5 rounded-full bg-white text-black font-bold text-[10px] md:text-xs uppercase tracking-wider hover:bg-[#5C5CFF] hover:text-white transition-all duration-300 shadow-[0_0_15px_rgba(255,255,255,0.3)] active:scale-95 touch-manipulation">
                  <Plus size={14} strokeWidth={3} className="md:w-4 md:h-4" /><span>Add<span className="hidden sm:inline"> Prompt</span></span>
                </button>
              </div>
            </header>
            <main className="pt-24 md:pt-28 pb-20 px-4 sm:px-6 z-10 relative">
              <div className="max-w-7xl mx-auto">
                <div className="flex flex-col-reverse md:flex-row md:items-center justify-between gap-4 md:gap-6 mb-8 md:mb-10">
                  <div className="w-full md:w-auto -mx-4 px-4 md:mx-0 md:px-0">
                    <div className="flex items-center gap-3 overflow-x-auto no-scrollbar pb-1">
                      {categories.map((cat) => {
                        const isSelected = activeCategory === cat;
                        let activeStyle = "bg-white text-black shadow-[0_0_20px_-5px_rgba(255,255,255,0.5)]";
                        
                        if (cat === 'NanoBanana') activeStyle = "bg-yellow-400 text-black shadow-[0_0_20px_-5px_rgba(250,204,21,0.5)]";
                        if (cat === 'Midjourney') activeStyle = "bg-blue-400 text-black shadow-[0_0_20px_-5px_rgba(96,165,250,0.5)]";
                        if (cat === 'Seedream') activeStyle = "bg-green-400 text-black shadow-[0_0_20px_-5px_rgba(74,222,128,0.5)]";

                        return (
                          <button 
                            key={cat} 
                            onClick={() => setActiveCategory(cat)} 
                            className={`px-4 md:px-5 py-2 md:py-2.5 rounded-full text-[11px] md:text-xs font-bold uppercase tracking-widest whitespace-nowrap transition-all duration-300 flex-shrink-0 touch-manipulation ${isSelected ? activeStyle : 'bg-white/5 text-white/50 hover:bg-white/10 hover:text-white'}`}
                          >
                            {cat}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                  <div className="relative w-full md:w-72 shrink-0 group">
                    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><Search size={16} className="text-white/30 group-focus-within:text-[#5C5CFF] transition-colors" /></div>
                    <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="Search prompts..." className="w-full bg-white/5 border border-white/10 text-white rounded-full pl-10 pr-4 py-2.5 text-sm focus:outline-none focus:bg-white/10 focus:border-[#5C5CFF]/50 transition-all placeholder:text-white/20 appearance-none" />
                  </div>
                </div>
                
                {loading ? (
                  <div className="flex flex-col items-center justify-center py-20 animate-in fade-in">
                    <Loader2 size={40} className="text-[#5C5CFF] animate-spin mb-4" />
                    <p className="text-white/50 text-sm font-display tracking-widest uppercase">Accessing Vault...</p>
                  </div>
                ) : error ? (
                   <div className="flex flex-col items-center justify-center py-16 md:py-20 text-center animate-in fade-in bg-red-500/10 rounded-3xl border border-red-500/20 p-8">
                    <div className="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center mb-4"><AlertTriangle size={32} className="text-red-400" /></div>
                    <h2 className="text-xl font-bold text-white mb-2">Connection Error</h2>
                    <p className="text-white/60 max-w-md mx-auto mb-4">{error.message || 'Could not connect to Supabase.'}</p>
                    <p className="text-white/40 text-sm max-w-md mx-auto">Ensure you have created the 'prompts' table in your Supabase project.</p>
                  </div>
                ) : filteredPrompts.length === 0 ? (
                  <div className="flex flex-col items-center justify-center py-16 md:py-20 text-center animate-in fade-in duration-700">
                    <div className="w-20 h-20 md:w-24 md:h-24 rounded-full bg-white/5 border border-white/10 flex items-center justify-center mb-6">{searchQuery ? <Search size={28} className="text-white/20 md:w-8 md:h-8" /> : <Plus size={28} className="text-white/20 md:w-8 md:h-8" />}</div>
                    <h2 className="text-lg md:text-xl font-display text-white/80 mb-2">{searchQuery ? `No results for "${searchQuery}"` : (activeCategory === 'All' ? 'Vault Empty' : `No ${activeCategory} Prompts`)}</h2>
                    <p className="text-white/40 max-w-xs mx-auto mb-8 text-sm md:text-base">{searchQuery ? 'Try checking your spelling or use different keywords.' : (activeCategory === 'All' ? 'Start your collection by adding your first AI generation prompt.' : 'Try selecting a different category or add a new one.')}</p>
                    {activeCategory === 'All' && !searchQuery && (<button onClick={() => { setEditingPrompt(null); setIsAddModalOpen(true); }} className="text-[#5C5CFF] hover:text-white transition-colors text-sm font-bold uppercase tracking-wider p-2">+ Add New Prompt</button>)}
                  </div>
                ) : (
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 md:gap-x-6 md:gap-y-12">
                    {filteredPrompts.map((prompt) => (<PromptCard key={prompt.id} data={prompt} onClick={() => window.location.hash = `#/view/${prompt.id}`} onEdit={() => { setEditingPrompt(prompt); setIsAddModalOpen(true); }} />))}
                  </div>
                )}
              </div>
            </main>
            <AddModal isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} onSave={handleSavePrompt} onDelete={handleDeletePrompt} initialData={editingPrompt} />
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>