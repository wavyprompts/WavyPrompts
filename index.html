<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>WavyPrompts</title>
    <link rel="icon" type="image/svg+xml" href="./logo.svg">
    
    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FIX: Polyfill for process.env.NODE_ENV to prevent React crash -->
    <script>
      window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <!-- Suppress Babel Warning -->
    <script>
      (function() {
        const originalWarn = console.warn;
        console.warn = function(...args) {
          if (args[0] && typeof args[0] === 'string' && args[0].includes('in-browser Babel transformer')) return;
          originalWarn.apply(console, args);
        };
      })();
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Syne:wght@400;500;600;700;800&family=Unbounded:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
      @font-face {
        font-family: 'Milker';
        src: url('./Milker.otf') format('opentype'),
             url('./Milker.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
      }

      html {
        scroll-behavior: auto; /* Let Lenis handle scrolling */
        height: 100%;
      }

      body {
        font-family: 'Poppins', sans-serif;
        background-color: #020202; /* Darker background */
        color: #ffffff;
        font-weight: 400;
        margin: 0;
        overflow-x: hidden;
        min-height: 100vh;
      }

      /* --- CUSTOM SCROLLBAR UI --- */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: content-box;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.25);
        border: 2px solid transparent;
        background-clip: content-box;
      }

      ::-webkit-scrollbar-corner {
        background: transparent;
      }

      /* Firefox Scrollbar Support */
      @supports (scrollbar-color: auto) {
        * {
          scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
          scrollbar-width: thin;
        }
      }
      
      h1, h2, h3, .font-display {
        font-family: 'Milker', 'Unbounded', 'Syne', sans-serif;
      }
      
      .glass-panel {
        background: rgba(20, 20, 20, 0.6);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
      }
      
      .glass-input {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        font-family: 'Poppins', sans-serif;
      }

      .glass-element {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .glass-element:hover {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      
      @keyframes breathe {
        0%, 100% { transform: scale(1.1); opacity: 0.2; }
        50% { transform: scale(1.2); opacity: 0.3; }
      }
      .animate-breathe {
        animation: breathe 10s ease-in-out infinite;
      }

      @keyframes text-reveal {
        0% { opacity: 0; filter: blur(12px); transform: translateY(10px); }
        100% { opacity: 1; filter: blur(0); transform: translateY(0); }
      }
      .animate-text-reveal {
        animation: text-reveal 1.2s cubic-bezier(0.19, 1, 0.22, 1) forwards;
      }

      /* Marquee Animations for Hero Section */
      @keyframes marquee-up {
        0% { transform: translateY(0); }
        100% { transform: translateY(-50%); }
      }
      @keyframes marquee-down {
        0% { transform: translateY(-50%); }
        100% { transform: translateY(0); }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react" data-type="module">
      import React, { useState, useEffect, useRef, useContext, createContext } from "https://esm.sh/react@18.2.0";
      import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";
      import { 
        Copy, Share2, Plus, X, ChevronLeft, Image as ImageIcon, 
        MoreHorizontal, Check, Pencil, Search, Sparkles, Loader2, AlertTriangle, Trash2, Upload, Link as LinkIcon, Info, XCircle, CheckCircle2,
        Database, Terminal, Calendar
      } from "https://esm.sh/lucide-react@0.263.1";
      // Import Lenis (New Package Name)
      import Lenis from "https://esm.sh/lenis@1.1.14";
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.3";

      // --- SUPABASE CONFIGURATION ---
      const SUPABASE_URL = 'https://wkxmzwvysahrczxbesgk.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndreG16d3Z5c2FocmN6eGJlc2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTUwMTcsImV4cCI6MjA4MTM3MTAxN30.m7GZaKsWT9KhvAU3dR88cSbVwtK1_FTUM1QL4cf8PN0';
      
      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      // --- SQL FIX SCRIPT ---
      const REPAIR_SQL = `
-- 1. RESET PROMPTS TABLE
create table if not exists public.prompts (
    id text primary key,
    title text,
    prompt text,
    image_url text,
    category text default 'NanoBanana',
    created_at timestamptz default now()
);

-- Ensure columns exist
alter table public.prompts add column if not exists category text default 'NanoBanana';
alter table public.prompts add column if not exists created_at timestamptz default now();

-- Fix Table Permissions (RLS)
alter table public.prompts enable row level security;
drop policy if exists "Enable all access" on public.prompts;
drop policy if exists "Public Access" on public.prompts;
create policy "Public Access" on public.prompts for all using (true) with check (true);
grant all on table public.prompts to anon;
grant all on table public.prompts to authenticated;

-- 2. FIX STORAGE (Fixes "Permission Denied" errors)
insert into storage.buckets (id, name, public) values ('images', 'images', true)
on conflict (id) do update set public = true;

-- Remove conflicting policies
drop policy if exists "Universal Public Images" on storage.objects;
drop policy if exists "Give me access" on storage.objects;
drop policy if exists "Public Access" on storage.objects;

-- Create UNIVERSAL open policy
create policy "Universal Public Images" on storage.objects for all 
using ( bucket_id = 'images' ) 
with check ( bucket_id = 'images' );

-- Explicit grants
grant all on table storage.objects to anon;
grant all on table storage.objects to authenticated;
`.trim();

      // --- TOAST CONTEXT ---
      const ToastContext = createContext(null);

      const ToastProvider = ({ children }) => {
        const [toasts, setToasts] = useState([]);

        const addToast = (message, type = 'success', duration = 5000) => {
          const id = Date.now();
          setToasts(prev => [...prev, { id, message, type }]);
          setTimeout(() => removeToast(id), duration);
        };

        const removeToast = (id) => {
          setToasts(prev => prev.filter(t => t.id !== id));
        };

        return (
          <ToastContext.Provider value={{ addToast }}>
            {children}
            <div className="fixed bottom-6 left-1/2 -translate-x-1/2 md:translate-x-0 md:left-auto md:bottom-6 md:right-6 z-[200] flex flex-col gap-3 pointer-events-none w-full max-w-[calc(100%-32px)] md:max-w-sm">
              {toasts.map(toast => (
                <div 
                  key={toast.id} 
                  className={`pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl border backdrop-blur-md shadow-2xl animate-in slide-in-from-bottom-full md:slide-in-from-right-full fade-in duration-300 w-full ${
                    toast.type === 'error' 
                      ? 'bg-red-500/10 border-red-500/20 text-red-200' 
                      : 'bg-[#1a1a1a]/90 border-white/10 text-white'
                  }`}
                >
                  <div className={`shrink-0 ${toast.type === 'error' ? 'text-red-400' : 'text-[#547EAE]'}`}>
                    {toast.type === 'error' ? <XCircle size={20} /> : <CheckCircle2 size={20} />}
                  </div>
                  <p className="text-sm font-medium leading-tight">{toast.message}</p>
                  <button onClick={() => removeToast(toast.id)} className="ml-auto opacity-50 hover:opacity-100 transition-opacity p-1">
                    <X size={14} />
                  </button>
                </div>
              ))}
            </div>
          </ToastContext.Provider>
        );
      };

      const useToast = () => {
        const context = useContext(ToastContext);
        if (!context) throw new Error("useToast must be used within a ToastProvider");
        return context;
      };

      // Data Mapping Helpers
      const mapFromDb = (row) => ({
        id: row.id,
        title: row.title,
        prompt: row.prompt,
        imageUrl: row.image_url,
        category: row.category,
        createdAt: row.created_at ? new Date(row.created_at).getTime() : Date.now()
      });

      const mapToDb = (data) => ({
        id: data.id,
        title: data.title,
        prompt: data.prompt,
        image_url: data.imageUrl,
        category: data.category,
        created_at: new Date(data.createdAt).toISOString()
      });

      // API Functions
      const fetchPrompts = async () => {
        const { data, error } = await supabase
          .from('prompts')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data.map(mapFromDb);
      };

      const checkDatabaseHealth = async () => {
        try {
          const { data, error } = await supabase.from('prompts').select('id, category').limit(1);
          if (error) throw error;
          return { healthy: true };
        } catch (error) {
           return { healthy: false, error: error.message };
        }
      };

      const uploadImageToSupabase = async (file) => {
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
        const filePath = `${fileName}`;

        const { data, error: uploadError } = await supabase.storage
          .from('images')
          .upload(filePath, file, { cacheControl: '3600', upsert: false });

        if (uploadError) {
          console.error("Storage upload error:", uploadError);
          if (uploadError.statusCode === '403' || uploadError.error === 'Unauthorized' || uploadError.message.includes('row-level security')) {
            throw new Error("Storage Permission Denied. Run the repair script.");
          }
          throw uploadError;
        }

        const { data: publicUrlData } = supabase.storage.from('images').getPublicUrl(filePath);
        return publicUrlData.publicUrl;
      };

      const savePromptToSupabase = async (prompt) => {
        const dbPayload = mapToDb(prompt);
        const { error } = await supabase.from('prompts').upsert(dbPayload, { onConflict: 'id' });
        if (error) throw error;
      };

      const deletePromptFromSupabase = async (id) => {
        const { error } = await supabase.from('prompts').delete().eq('id', id);
        if (error) throw error;
      };

      const encodeShareData = (data) => {
        try {
          const payload = { ...data };
          const json = JSON.stringify(payload);
          return btoa(String.fromCharCode(...new TextEncoder().encode(json)));
        } catch (e) { return ""; }
      };

      const decodeShareData = (encoded) => {
        try {
          const binaryString = atob(encoded);
          const bytes = Uint8Array.from(binaryString, c => c.charCodeAt(0));
          return JSON.parse(new TextDecoder().decode(bytes));
        } catch (e) { return null; }
      };

      // Components

      const Button = ({ children, variant = 'primary', fullWidth = false, className = '', ...props }) => {
        const baseStyles = "inline-flex items-center justify-center transition-all duration-200 font-medium tracking-wide disabled:opacity-50 disabled:cursor-not-allowed select-none active:scale-[0.98]";
        const variants = {
          primary: "bg-[#547EAE] hover:bg-[#4a4aff] text-white rounded-full px-6 py-3 shadow-[0_0_20px_-5px_#547EAE]",
          secondary: "bg-white text-black hover:bg-gray-200 rounded-full px-6 py-3",
          ghost: "bg-transparent text-white/70 hover:text-white hover:bg-white/10 rounded-lg p-2",
          icon: "bg-white/10 hover:bg-white/20 text-white rounded-full p-2 backdrop-blur-md",
          danger: "bg-red-500/10 hover:bg-red-500/20 text-red-400 hover:text-red-300 rounded-full px-4 py-3 border border-red-500/20"
        };
        return <button className={`${baseStyles} ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className}`} {...props}>{children}</button>;
      };

      const HeroSection = ({ prompts }) => {
        // Use real prompts or fallbacks. Ensure we have enough to fill columns nicely.
        const pool = prompts && prompts.length > 0 ? prompts : Array.from({length: 12}).fill(null);
        // Duplicate pool to ensure enough items for scrolling effect
        const items = [...pool, ...pool, ...pool, ...pool].slice(0, 36); 
        
        // Create 6 columns
        const cols = [[], [], [], [], [], []];
        items.forEach((item, i) => {
            cols[i % 6].push(item);
        });

        return (
          <div className="relative w-full h-[400px] md:h-[480px] rounded-[32px] overflow-hidden mb-12 border border-white/10 shadow-2xl bg-[#0a0a0a] group">
              {/* Background Columns - Tilted and Animated */}
              <div className="absolute inset-[-100px] opacity-70 flex gap-4 justify-center items-start transform -rotate-6 scale-110 pointer-events-none select-none">
                  {cols.map((colItems, colIndex) => (
                      <div 
                        key={colIndex} 
                        className="flex flex-col gap-4 w-1/3 sm:w-1/4 md:w-1/6 shrink-0"
                        style={{
                            animation: `${colIndex % 2 === 0 ? 'marquee-up' : 'marquee-down'} ${40 + (colIndex * 5)}s linear infinite`
                        }}
                      >
                          {/* Render items twice for seamless loop */}
                          {[...colItems, ...colItems].map((p, i) => (
                              <div key={i} className="w-full aspect-[4/5] rounded-xl bg-gray-800/50 overflow-hidden border border-white/5 relative">
                                 <img 
                                    src={p ? p.imageUrl : `https://picsum.photos/seed/${colIndex * 100 + i}/400/500`} 
                                    className="w-full h-full object-cover transition-all duration-700 ease-out" 
                                    loading="lazy"
                                    alt=""
                                 />
                              </div>
                          ))}
                      </div>
                  ))}
              </div>

              {/* Dark Gradient Overlay for Readability - Reduced darkness */}
              <div className="absolute inset-0 bg-gradient-to-t from-[#020202] via-[#020202]/60 to-black/10"></div>
              
              {/* Content */}
              <div className="absolute inset-0 flex flex-col items-center justify-center z-10 p-6 text-center">
                   <h1 className="font-display font-black text-5xl md:text-7xl lg:text-8xl tracking-tighter leading-[0.85] text-white drop-shadow-2xl flex flex-col gap-0 md:gap-2">
                      <span>STAY WAVY</span>
                      <span className="text-white/90">PROMPT SMARTER</span>
                   </h1>
                   <p className="text-white/50 text-sm md:text-base font-medium max-w-md mt-6 md:mt-8 tracking-wide">
                      Discover and collect the best AI prompts in your personal vault.
                   </p>
              </div>
          </div>
        );
      };

      const RepairModal = ({ isOpen, onClose, errorMsg }) => {
        const [copied, setCopied] = useState(false);
        if (!isOpen) return null;

        const handleCopy = () => {
          navigator.clipboard.writeText(REPAIR_SQL);
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        };

        return (
          <div className="fixed inset-0 z-[250] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" />
            <div className="glass-panel w-full max-w-2xl rounded-3xl p-6 md:p-8 relative animate-in fade-in zoom-in-95 duration-200 border border-red-500/30 shadow-[0_0_50px_-10px_rgba(239,68,68,0.2)]">
              <div className="flex items-center gap-4 mb-6">
                <div className="p-3 rounded-full bg-red-500/20 text-red-400"><Database size={24} /></div>
                <div>
                  <h2 className="text-xl font-bold font-display text-white">Database Setup Required</h2>
                  <p className="text-red-300 text-sm">Permission or Schema error detected in Supabase</p>
                </div>
              </div>
              
              <div className="bg-black/40 rounded-xl p-4 mb-6 border border-white/10">
                <p className="text-white/60 text-sm mb-2 font-mono">Error Details:</p>
                <code className="text-red-300 text-xs break-all">{errorMsg}</code>
              </div>

              <p className="text-white/80 mb-4 text-sm">To fix this, copy the SQL code below and run it in your <a href="https://supabase.com/dashboard/project/_/sql" target="_blank" className="text-[#547EAE] hover:underline font-bold">Supabase SQL Editor</a>.</p>
              
              <div className="relative group mb-6">
                <pre className="bg-[#050505] p-4 rounded-xl text-xs text-gray-400 font-mono overflow-x-auto h-48 border border-white/10 shadow-inner">
                  {REPAIR_SQL}
                </pre>
                <button onClick={handleCopy} className="absolute top-2 right-2 px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-lg text-white text-xs font-bold transition-colors flex items-center gap-2 backdrop-blur-md">
                  {copied ? <Check size={14} /> : <Copy size={14} />}
                  {copied ? 'Copied' : 'Copy SQL'}
                </button>
              </div>

              <div className="flex justify-end gap-3">
                <Button variant="ghost" onClick={onClose}>Ignore</Button>
                <Button onClick={() => window.location.reload()} variant="primary">I've Run It, Reload App</Button>
              </div>
            </div>
          </div>
        );
      };

      const PromptCard = ({ data, onClick, onEdit }) => {
        const [copied, setCopied] = useState(false);
        const category = data.category || 'NanoBanana';
        const { addToast } = useToast();

        const handleShare = (e) => {
          e.stopPropagation();
          const encoded = encodeShareData(data);
          if (!encoded) return;
          const url = `${window.location.origin}${window.location.pathname}#/share/${encoded}`;
          navigator.clipboard.writeText(url).then(() => {
            setCopied(true);
            addToast("Link copied!");
            setTimeout(() => setCopied(false), 2000);
          });
        };

        const getDotColor = (c) => {
          switch(c) {
            case 'NanoBanana': return 'bg-[#FFD700] shadow-[0_0_8px_rgba(255,215,0,0.5)]';
            case 'Midjourney': return 'bg-[#00BFFF] shadow-[0_0_8px_rgba(0,191,255,0.5)]';
            case 'Seedream': return 'bg-[#00FA9A] shadow-[0_0_8px_rgba(0,250,154,0.5)]';
            default: return 'bg-white';
          }
        };

        return (
          <div onClick={onClick} className="group cursor-pointer flex flex-col gap-4 active:scale-[0.98] transition-transform duration-200">
            <div className="relative w-full aspect-[4/5] rounded-[24px] md:rounded-[32px] overflow-hidden border border-white/5 bg-[#050505] z-10 shadow-2xl ring-1 ring-white/5 group-hover:ring-white/10 transition-all duration-500">
              {data.imageUrl ? (
                <img src={data.imageUrl} alt={data.title} className="w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-[1.03]" loading="lazy" />
              ) : (
                <div className="w-full h-full flex flex-col items-center justify-center text-white/20 bg-white/5"><ImageIcon size={48} /></div>
              )}
            </div>
            <div className="flex flex-col gap-2">
              <h3 className="text-lg md:text-xl font-extrabold font-display text-white tracking-tight truncate px-1">{data.title}</h3>
              <div className="flex items-center justify-between gap-3 px-1 w-full">
                <div className="glass-element flex items-center gap-2 px-2.5 py-1.5 md:px-3 md:py-2 rounded-full transition-all duration-300 hover:bg-white/10 border border-white/10">
                  <div className={`w-1.5 h-1.5 md:w-2 md:h-2 rounded-full flex-shrink-0 ${getDotColor(category)}`}></div>
                  <span className="text-[10px] md:text-xs font-bold uppercase tracking-widest text-white/90 font-display whitespace-nowrap">{category}</span>
                </div>
                <div className="flex items-center gap-2 flex-shrink-0">
                  <button onClick={(e) => {e.stopPropagation(); onEdit();}} className="glass-element w-9 h-9 md:w-10 md:h-10 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-all border border-white/10 active:bg-white/20"><Pencil size={15} /></button>
                  <button onClick={handleShare} className={`glass-element w-9 h-9 md:w-10 md:h-10 flex items-center justify-center rounded-full transition-all border border-white/10 active:bg-white/20 ${copied ? 'bg-white text-black' : 'text-white/70 hover:text-white'}`}>{copied ? <Check size={16} /> : <Share2 size={16} />}</button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const AddModal = ({ isOpen, onClose, onSave, onDelete, initialData }) => {
        const [title, setTitle] = useState('');
        const [prompt, setPrompt] = useState('');
        const [imageMode, setImageMode] = useState('upload');
        const [imageUrl, setImageUrl] = useState('');
        const [selectedFile, setSelectedFile] = useState(null);
        const [previewUrl, setPreviewUrl] = useState('');
        const [category, setCategory] = useState('NanoBanana');
        const [isSaving, setIsSaving] = useState(false);
        const [savingStatus, setSavingStatus] = useState('idle');
        const [isDeleting, setIsDeleting] = useState(false);
        const fileInputRef = useRef(null);
        const { addToast } = useToast();

        useEffect(() => {
          if (isOpen) {
            setSavingStatus('idle');
            if (initialData) {
              setTitle(initialData.title);
              setPrompt(initialData.prompt);
              setImageUrl(initialData.imageUrl);
              setPreviewUrl(initialData.imageUrl);
              setImageMode('link');
              setCategory(initialData.category || 'NanoBanana');
            } else {
              setTitle('');
              setPrompt('');
              setImageUrl('');
              setPreviewUrl('');
              setImageMode('upload');
              setCategory('NanoBanana');
            }
            setSelectedFile(null);
          }
        }, [isOpen, initialData]);

        const handleFileChange = (e) => {
          const file = e.target.files[0];
          if (file) {
            setSelectedFile(file);
            setPreviewUrl(URL.createObjectURL(file));
          }
        };

        if (!isOpen) return null;

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (isSaving) return;
          setIsSaving(true);
          setSavingStatus('starting');
          
          try {
            const baseData = {
              id: initialData ? initialData.id : Date.now().toString(),
              title,
              prompt,
              imageUrl: imageMode === 'link' ? imageUrl : (initialData?.imageUrl || 'https://picsum.photos/800/1000'),
              category,
              createdAt: initialData ? initialData.createdAt : Date.now()
            };

            const fileToUpload = (imageMode === 'upload' && selectedFile) ? selectedFile : null;

            await onSave(baseData, fileToUpload, (status) => setSavingStatus(status));
            
            addToast(initialData ? "Vault entry updated!" : "Saved to Vault!");
            onClose();
          } catch (err) {
             console.error("Modal caught error:", err);
             addToast(err.message || "Failed to save.", "error");
          } finally {
            setIsSaving(false);
            setSavingStatus('idle');
          }
        };

        return (
          <div className="fixed inset-0 z-[150] flex items-end md:items-center justify-center sm:p-4">
            <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose} />
            <div data-lenis-prevent className="glass-panel w-full md:max-w-lg max-h-[95vh] md:max-h-[90vh] overflow-y-auto rounded-t-3xl md:rounded-3xl p-6 md:p-8 relative animate-in slide-in-from-bottom-full md:slide-in-from-bottom-10 fade-in zoom-in-95 duration-300">
              <button onClick={onClose} className="absolute top-4 right-4 p-2 text-white/50 hover:text-white transition-colors z-10"><X size={24} /></button>
              
              {/* Mobile Drag Handle */}
              <div className="w-12 h-1.5 bg-white/20 rounded-full mx-auto mb-6 md:hidden"></div>

              <h2 className="text-xl md:text-2xl font-bold font-display mb-6 bg-gradient-to-r from-white to-white/50 bg-clip-text text-transparent">{initialData ? 'Edit Prompt' : 'Add to Vault'}</h2>
              <form onSubmit={handleSubmit} className="space-y-5 pb-safe-bottom">
                <div className="space-y-2"><label className="text-sm text-white/60 font-medium ml-1">Title</label><input required type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="e.g. Cyberpunk Cat" className="glass-input w-full rounded-xl px-4 py-3 focus:outline-none focus:border-[#547EAE]/50 transition-colors text-[16px] md:text-sm" /></div>
                
                <div className="space-y-2">
                  <label className="text-sm text-white/60 font-medium ml-1">Category</label>
                  <div className="flex gap-2 flex-wrap">
                    {['NanoBanana', 'Midjourney', 'Seedream'].map((cat) => {
                       const isSelected = category === cat;
                       let activeClass = isSelected ? (cat === 'NanoBanana' ? 'bg-yellow-400 border-yellow-400 text-black' : cat === 'Midjourney' ? 'bg-blue-400 border-blue-400 text-black' : 'bg-green-400 border-green-400 text-black') : 'bg-white/5 border-white/10 text-white/60 hover:bg-white/10';
                       return <button key={cat} type="button" onClick={() => setCategory(cat)} className={`px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wider transition-all border ${activeClass}`}>{cat}</button>;
                    })}
                  </div>
                </div>

                <div className="space-y-3">
                  <label className="text-sm text-white/60 font-medium ml-1">Image (4:5)</label>
                  <div className="flex gap-2 mb-2"><button type="button" onClick={() => setImageMode('upload')} className={`text-xs font-bold px-3 py-1.5 rounded-lg ${imageMode === 'upload' ? 'bg-[#547EAE] text-white' : 'text-white/50'}`}>Upload</button><button type="button" onClick={() => setImageMode('link')} className={`text-xs font-bold px-3 py-1.5 rounded-lg ${imageMode === 'link' ? 'bg-[#547EAE] text-white' : 'text-white/50'}`}>URL</button></div>
                  {imageMode === 'upload' ? (
                     <div onClick={() => fileInputRef.current?.click()} className="group relative w-full aspect-[4/5] max-h-[200px] rounded-xl border-2 border-dashed border-white/10 hover:border-[#547EAE]/50 bg-white/5 flex flex-col items-center justify-center cursor-pointer overflow-hidden active:scale-[0.99] transition-transform">
                      {previewUrl ? <img src={previewUrl} className="w-full h-full object-cover opacity-60" /> : <div className="flex flex-col items-center"><Upload size={24} /><span className="text-xs font-bold mt-2">Click to Upload</span></div>}
                      <input ref={fileInputRef} type="file" accept="image/*" className="hidden" onChange={handleFileChange} />
                     </div>
                  ) : (
                    <input type="url" value={imageUrl} onChange={(e) => { setImageUrl(e.target.value); setPreviewUrl(e.target.value); }} placeholder="https://..." className="glass-input w-full rounded-xl px-4 py-3 text-[16px] md:text-sm" />
                  )}
                </div>

                <div className="space-y-2"><label className="text-sm text-white/60 font-medium ml-1">Prompt</label><textarea required value={prompt} onChange={(e) => setPrompt(e.target.value)} rows={5} className="glass-input w-full rounded-xl px-4 py-3 focus:outline-none focus:border-[#547EAE]/50 resize-none text-[16px] md:text-sm" /></div>
                
                <div className="flex gap-3 mt-4">
                  {initialData && <Button type="button" variant="danger" onClick={async () => { if(confirm('Delete?')) { setIsDeleting(true); await onDelete(initialData.id).catch(() => {}); onClose(); } }} disabled={isDeleting} className="w-12 px-0"><Trash2 size={20} /></Button>}
                  <Button type="submit" fullWidth disabled={isSaving}>
                    {isSaving ? (
                      <div className="flex items-center gap-2">
                        <Loader2 className="animate-spin" size={18} />
                        <span>
                           {savingStatus === 'uploading' && 'Uploading Image...'}
                           {savingStatus === 'saving' && 'Saving Data...'}
                           {savingStatus === 'syncing' && 'Syncing Vault...'}
                           {savingStatus === 'starting' && 'Processing...'}
                        </span>
                      </div>
                    ) : (initialData ? 'Update Vault' : 'Save to Vault')}
                  </Button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      const FullView = ({ data, isOwner, onBack, onEdit }) => {
        const [copied, setCopied] = useState(false);
        const { addToast } = useToast();

        const getDotColor = (c) => {
          switch(c) {
            case 'NanoBanana': return 'bg-[#FFD700] shadow-[0_0_8px_rgba(255,215,0,0.5)]';
            case 'Midjourney': return 'bg-[#00BFFF] shadow-[0_0_8px_rgba(0,191,255,0.5)]';
            case 'Seedream': return 'bg-[#00FA9A] shadow-[0_0_8px_rgba(0,250,154,0.5)]';
            default: return 'bg-white';
          }
        };

        const handleCopy = () => {
          navigator.clipboard.writeText(data.prompt);
          setCopied(true);
          addToast("Copied!");
          setTimeout(() => setCopied(false), 2000);
        };

        const handleShare = () => {
          const encoded = encodeShareData(data);
          if (!encoded) return;
          const url = `${window.location.origin}${window.location.pathname}#/share/${encoded}`;
          navigator.clipboard.writeText(url).then(() => {
            addToast("Share link copied!");
          });
        };

        return (
          <div data-lenis-prevent className="fixed inset-0 z-[100] bg-black text-white overflow-y-auto">
             {/* Sticky Header */}
             <div className="sticky top-0 left-0 right-0 z-50 bg-black/80 backdrop-blur-md px-4 py-4 md:px-6 flex items-center justify-between border-b border-white/5 pt-[env(safe-area-inset-top)]">
                {isOwner ? (
                  <button onClick={onBack} className="p-2.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors active:scale-95">
                    <ChevronLeft size={24} />
                  </button>
                ) : <div className="w-10 h-10"></div>}
                
                <div className="font-extrabold text-xl tracking-tight" style={{ fontFamily: 'Unbounded, sans-serif' }}>WavyPrompts</div>
                
                {isOwner ? (
                  <button onClick={onEdit} className="p-2.5 rounded-full bg-white/10 hover:bg-white/20 text-white/70 hover:text-white transition-colors active:scale-95">
                    <Pencil size={20} />
                  </button>
                ) : <div className="w-10 h-10"></div>}
             </div>

             <div className="max-w-xl mx-auto px-4 pb-[calc(8rem+env(safe-area-inset-bottom))] pt-6 flex flex-col items-center w-full">
                
                {/* Main Image */}
                <div className="relative w-full aspect-[4/5] rounded-[24px] md:rounded-[32px] overflow-hidden bg-[#111] border border-white/10 shadow-2xl mb-6 md:mb-8">
                  <img src={data.imageUrl} className="w-full h-full object-cover" />
                </div>

                {/* Content Container */}
                <div className="w-full flex flex-col gap-4 md:gap-5 px-1 min-w-0">
                   {/* Title */}
                   <h1 className="text-2xl md:text-4xl font-black font-display text-white leading-tight tracking-tight text-left break-all">{data.title}</h1>
                   
                   {/* Meta Tags */}
                   <div className="flex flex-wrap items-center gap-3">
                      <div className="glass-element flex items-center gap-2 px-3 py-2 rounded-full border border-white/10">
                         <div className={`w-2 h-2 rounded-full flex-shrink-0 ${getDotColor(data.category || 'NanoBanana')}`}></div>
                         <span className="text-xs font-bold uppercase tracking-widest text-white/90 font-display whitespace-nowrap">{data.category || 'NanoBanana'}</span>
                      </div>
                   </div>

                   {/* Prompt Box */}
                   <div className="w-full bg-[#161616] border border-white/10 rounded-2xl p-5 md:p-6 mt-2 relative min-w-0 overflow-hidden">
                      <p className="text-sm md:text-base text-gray-300 font-medium leading-relaxed whitespace-pre-wrap select-text break-all">
                        {data.prompt}
                      </p>
                   </div>
                </div>
             </div>

             {/* Sticky Action Footer */}
             <div className="fixed bottom-0 left-0 right-0 p-4 md:p-6 bg-gradient-to-t from-black via-black to-transparent z-50 pb-[calc(1rem+env(safe-area-inset-bottom))]">
                <div className="max-w-xl mx-auto flex gap-4">
                   <Button onClick={handleCopy} fullWidth variant="primary" className="h-14 text-base font-bold shadow-lg shadow-[#547EAE]/30 rounded-full hover:scale-[1.02] active:scale-95 transition-transform">
                      {copied ? 'Copied!' : 'Copy prompt'}
                   </Button>
                </div>
             </div>
          </div>
        );
      };

      // FIX: Moved MainApp logic outside of App to prevent infinite re-rendering (flickering)
      const MainApp = () => {
        // Initialize state based on URL hash to prevent flash of homepage
        const [sharedData, setSharedData] = useState(() => {
          const hash = window.location.hash;
          if (hash.startsWith('#/share/')) {
            return decodeShareData(hash.split('#/share/')[1]);
          }
          return null;
        });

        const [view, setView] = useState(() => {
          const hash = window.location.hash;
          if (hash.startsWith('#/share/') && decodeShareData(hash.split('#/share/')[1])) {
            return 'shared';
          }
          return 'gallery';
        });

        const [prompts, setPrompts] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [dbError, setDbError] = useState(null);
        const [selectedPrompt, setSelectedPrompt] = useState(null);
        
        const [isAddModalOpen, setIsAddModalOpen] = useState(false);
        const [editingPrompt, setEditingPrompt] = useState(null);
        
        // Navigation State (active category acts as "page")
        const [activeCategory, setActiveCategory] = useState('All');
        const [searchQuery, setSearchQuery] = useState('');
        
        const { addToast } = useToast();

        // Theme Configuration
        const themeColors = {
          'All': '#547EAE', // Default/Home
          'NanoBanana': '#FFD700', // Yellow
          'Midjourney': '#00BFFF', // Blue
          'Seedream': '#00FA9A' // Green
        };
        const currentTheme = themeColors[activeCategory] || '#547EAE';

        useEffect(() => {
          const init = async () => {
            setLoading(true);
            
            // Check DB Health First
            const health = await checkDatabaseHealth();
            if (!health.healthy) {
              setDbError(health.error); 
            }

            try {
              const data = await fetchPrompts();
              setPrompts(data);
              checkHash(data);
            } catch (err) {
              if (!health.healthy) {
                console.warn("Fetch failed due to DB schema");
              } else {
                setError(err.message);
              }
            } finally {
              setLoading(false);
            }
          };

          const checkHash = (currentPrompts) => {
            const hash = window.location.hash;
            if (hash.startsWith('#/share/')) {
              // Redundant if handled in initial state, but good for safety
              const decoded = decodeShareData(hash.split('#/share/')[1]);
              if (decoded) { setSharedData(decoded); setView('shared'); } 
            } else if (hash.startsWith('#/view/')) {
              const id = hash.split('#/view/')[1];
              const found = currentPrompts.find(p => p.id === id);
              if (found) { setSelectedPrompt(found); setView('full'); }
            }
          };

          init();

          // Smooth Scroll
          const lenis = new Lenis({ duration: 1.2, smoothWheel: true });
          function raf(time) { lenis.raf(time); requestAnimationFrame(raf); }
          requestAnimationFrame(raf);

          return () => lenis.destroy();
        }, []);

        const handleSave = async (promptData, imageFile, onStatusUpdate) => { 
          try {
            let finalImageUrl = promptData.imageUrl;
            
            // Handle Image Upload if file exists
            if (imageFile) {
                 if (onStatusUpdate) onStatusUpdate('uploading');
                 try {
                     finalImageUrl = await uploadImageToSupabase(imageFile);
                 } catch (uploadErr) {
                     const msg = (uploadErr.message || "").toLowerCase();
                     if (msg.includes('storage permission') || msg.includes('row-level security') || msg.includes('403')) {
                         setDbError("Storage Permissions Denied. Please run the repair script to fix your bucket policies.");
                         throw new Error("Storage Permission Denied. Run the repair script.");
                     }
                     throw uploadErr;
                 }
            }

            if (onStatusUpdate) onStatusUpdate('saving');
            const payload = {
                ...promptData,
                imageUrl: finalImageUrl
            };

            await savePromptToSupabase(payload);
            
            if (onStatusUpdate) onStatusUpdate('syncing');
            const data = await fetchPrompts(); 
            setPrompts(data); 
          } catch (err) {
              console.error(err);
              const msg = (err.message || "Unknown error").toLowerCase();
              if (msg.includes('column') || msg.includes('does not exist') || msg.includes('42703')) {
                addToast("⚠️ DB Schema Error: Columns missing.", 'error');
                setDbError(err.message);
              } else if (msg.includes('policy') || msg.includes('permission') || msg.includes('42501')) {
                addToast("⚠️ DB Permission Error: RLS Policy violation.", 'error');
                setDbError("Row-Level Security (RLS) Policy Violation. Please run the repair script.");
              } else {
                // If it's the storage permission error we rethrew, it's already setDbError, but we might want to log it
              }
              throw err; 
          }
        };

        const handleDelete = async (id) => { 
          try {
              await deletePromptFromSupabase(id); 
              const data = await fetchPrompts(); 
              setPrompts(data); 
          } catch (err) {
              console.error(err);
              const msg = (err.message || "Unknown error").toLowerCase();
              if (msg.includes('policy') || msg.includes('permission') || msg.includes('42501')) {
                setDbError("Row-Level Security (RLS) Policy Violation. Please run the repair script.");
              }
              throw err;
          }
        };

        const filtered = prompts.filter(p => (activeCategory === 'All' || (p.category || 'NanoBanana') === activeCategory) && (p.title.toLowerCase().includes(searchQuery.toLowerCase())));

        return (
          <div className="min-h-screen relative text-white selection:text-white">
            <style>{`::selection { background-color: ${currentTheme}; color: black; }`}</style>

            {/* Database Repair Modal */}
            <RepairModal isOpen={!!dbError} onClose={() => setDbError(null)} errorMsg={dbError} />

            {/* Dynamic Background with Theme Color */}
            <div className="fixed inset-0 z-[-1] bg-[#020202] transition-colors duration-700">
              <div 
                 className="absolute top-[-20%] left-[-20%] w-[80vw] h-[80vw] blur-[120px] transition-all duration-1000 ease-in-out" 
                 style={{ backgroundColor: currentTheme, opacity: 0.04 }}
              />
              <div 
                 className="absolute bottom-[-20%] right-[-20%] w-[80vw] h-[80vw] blur-[120px] transition-all duration-1000 ease-in-out" 
                 style={{ backgroundColor: currentTheme, opacity: 0.02 }}
              />
            </div>

            {view === 'shared' && sharedData ? <FullView data={sharedData} isOwner={false} onBack={() => {}} /> : 
              view === 'full' && selectedPrompt ? <><FullView data={selectedPrompt} isOwner={true} onBack={() => {window.location.hash=''; setView('gallery');}} onEdit={() => { setEditingPrompt(selectedPrompt); setIsAddModalOpen(true); }} /><AddModal isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} onSave={handleSave} onDelete={handleDelete} initialData={editingPrompt} /></> : (
              <>
                <header className="fixed top-0 left-0 right-0 z-40 flex justify-center pointer-events-none px-4 pt-[calc(1rem+env(safe-area-inset-top))] md:pt-6">
                  <div className="pointer-events-auto w-full max-w-6xl bg-black/40 backdrop-blur-[32px] saturate-150 border border-white/10 shadow-[0_20px_40px_-10px_rgba(0,0,0,0.6)] rounded-full py-3 px-2 pl-3 md:pl-4 pr-2 md:pr-2 flex items-center justify-between transition-all duration-500 hover:bg-black/60 hover:border-white/20 ring-1 ring-white/5 group">
                    
                    {/* Left: Logo */}
                    <div className="flex-1 flex items-center justify-start gap-3 md:gap-4 min-w-0">
                      <img src="./logo.svg" alt="Logo" className="w-10 h-10 group-hover:scale-110 transition-transform duration-300 drop-shadow-lg" />
                      <h1 className="hidden lg:block text-xl md:text-2xl font-extrabold tracking-tighter text-white truncate" style={{ fontFamily: 'Unbounded, sans-serif' }}>
                        Wavy<span style={{ color: '#547EAE' }}>Prompts</span>
                      </h1>
                    </div>

                    {/* Center: Navigation */}
                    <nav className="flex justify-center items-center overflow-hidden mx-2 md:mx-4 shrink-0">
                      <div className="flex items-center gap-1 md:gap-2 overflow-x-auto no-scrollbar mask-fade px-2 py-1">
                        {[
                          { id: 'All', label: 'Home' },
                          { id: 'NanoBanana', label: 'NanoBanana' },
                          { id: 'Midjourney', label: 'Midjourney' },
                          { id: 'Seedream', label: 'Seedream' }
                        ].map((item) => {
                           const isActive = activeCategory === item.id;
                           return (
                             <button
                               key={item.id}
                               onClick={() => setActiveCategory(item.id)}
                               className={`px-3 py-1.5 md:px-4 md:py-2 rounded-full text-[10px] md:text-xs font-bold uppercase tracking-widest transition-all duration-300 whitespace-nowrap ${isActive ? 'shadow-[0_0_15px_rgba(0,0,0,0.3)] text-black' : 'hover:bg-white/5 text-white/50 hover:text-white'}`}
                               style={isActive ? { backgroundColor: currentTheme, color: '#000000', boxShadow: `0 0 15px ${currentTheme}60` } : {}}
                             >
                               {item.label}
                             </button>
                           );
                        })}
                      </div>
                    </nav>

                    {/* Right: Add Button */}
                    <div className="flex-1 flex items-center justify-end min-w-0">
                      <button onClick={() => { setEditingPrompt(null); setIsAddModalOpen(true); }} className="flex items-center gap-2 px-5 py-3 rounded-full bg-white text-black font-bold text-xs uppercase tracking-wider hover:bg-[#547EAE] hover:text-white transition-all shadow-[0_0_20px_-5px_rgba(255,255,255,0.3)] active:scale-95 active:bg-[#547EAE] active:text-white whitespace-nowrap" style={{ '--hover-color': currentTheme }}>
                        <Plus size={16} strokeWidth={3} />
                        <span className="hidden md:inline">ADD PROMPT</span>
                        <span className="md:hidden">ADD</span>
                      </button>
                    </div>
                  </div>
                </header>

                <main className="pt-24 md:pt-28 pb-20 px-4 md:px-6 z-10 relative max-w-7xl mx-auto">
                  
                  {/* HERO SECTION */}
                  <HeroSection prompts={prompts} />

                  {/* Search Bar - Full Width Centered */}
                  <div className="mb-8 md:mb-10 max-w-2xl mx-auto w-full">
                    <div className="relative w-full group">
                      <Search size={16} className="absolute left-4 top-3 text-white/30 group-focus-within:opacity-100 transition-all duration-300" style={{ color: 'rgba(255,255,255,0.3)' }} />
                      <input 
                        type="text" 
                        value={searchQuery} 
                        onChange={(e) => setSearchQuery(e.target.value)} 
                        placeholder={`Search ${activeCategory === 'All' ? 'all' : activeCategory} prompts...`} 
                        className="w-full bg-white/5 border border-white/10 text-white rounded-full pl-10 pr-4 py-3 text-sm focus:outline-none focus:bg-white/10 transition-all text-[16px] md:text-sm shadow-lg" 
                        style={{ outlineColor: currentTheme }}
                        onFocus={(e) => e.target.style.borderColor = currentTheme}
                        onBlur={(e) => e.target.style.borderColor = 'rgba(255,255,255,0.1)'}
                      />
                    </div>
                  </div>

                  {loading ? (
                    <div className="flex flex-col items-center justify-center py-20">
                      <Loader2 size={40} className="animate-spin mb-4" style={{ color: currentTheme }} />
                      <p className="text-white/50 text-sm font-display tracking-widest uppercase">Syncing Vault...</p>
                    </div>
                  ) : filtered.length === 0 ? (
                    <div className="flex flex-col items-center justify-center py-20 text-center">
                      <div className="w-24 h-24 rounded-full bg-white/5 border border-white/10 flex items-center justify-center mb-6"><Plus size={28} className="text-white/20" /></div>
                      <h2 className="text-xl font-display text-white/80 mb-2">Vault Empty</h2>
                      <p className="text-white/40 max-w-xs mx-auto mb-8">Start your collection by adding your first AI generation prompt.</p>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                      {filtered.map((prompt) => (<PromptCard key={prompt.id} data={prompt} onClick={() => { window.location.hash = `#/view/${prompt.id}`; setSelectedPrompt(prompt); setView('full'); }} onEdit={() => { setEditingPrompt(prompt); setIsAddModalOpen(true); }} />))}
                    </div>
                  )}
                </main>
                <AddModal isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} onSave={handleSave} onDelete={handleDelete} initialData={editingPrompt} />
              </>
            )}
          </div>
        );
      };

      const App = () => {
        return (
          <ToastProvider>
            <MainApp />
          </ToastProvider>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>